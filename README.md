Rewrite and bug fix of https://mankalo.booth.pm/items/2761082